---
title: "ã€Flutterã€‘React Hooks é¢¨ã®çŠ¶æ…‹ç®¡ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€ŒReArchã€ã®ç´¹ä»‹"
emoji: "ğŸŒ‰"
type: "tech"
topics: [flutter, dart, rearch, architecture, AIé§†å‹•é–‹ç™º]
published: true
---

æœ€è¿‘ã¯ Claude Code ã‚’ä½¿ã£ã¦ã€Flutter ã‚¢ãƒ—ãƒªã‚’ä¸€ã‹ã‚‰ä½œæˆã—ã¦ã‚‚ã‚‰ã†ã“ã¨ãŒå¤šã„ã®ã§ã™ãŒã€AI ã¯ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§å®Œçµã—ãªã„çŠ¶æ…‹ç®¡ç†ã‚’è‹¦æ‰‹ã¨ã—ã¦ã„ã‚‹ã‚ˆã†ã«æ„Ÿã˜ã¾ã™ã€‚
å…·ä½“çš„ã«ã¯ã€è¦ªã‹ã‚‰DIã§å—ã‘æ¸¡ã•ã‚Œã‚‹ã‚‚ã®ã‚„ã€ä½¿ç”¨ã•ã‚Œãªããªã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è‡ªå‹•çš„ã«è§£æ”¾ã•ã‚Œã‚‹ã‚‚ã®ã§ã™ã€‚

ãã“ã§ã€AI ã«ã¨ã£ã¦æ‰±ã„ã‚„ã™ã„çŠ¶æ…‹ç®¡ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ¢ã—ãŸã¨ã“ã‚ã€ã€Œ**ReArch**ã€ã«è¾¿ã‚Šç€ãã¾ã—ãŸã€‚

https://pub.dev/packages/flutter_rearch

https://rearch.gsconrad.com

# ReArchã®æ›¸ãæ–¹

ReArchã¯ Flutter Hooks ã‚„ React Hooks ã¨æ›¸ãæ–¹ãŒéå¸¸ã«ä¼¼ã¦ã„ã‚‹ãŸã‚ã€ã©ã¡ã‚‰ã‹ã‚’ä½¿ã£ãŸã“ã¨ã®ã‚ã‚‹æ–¹ãªã‚‰ã™ã‚“ãªã‚Šç¿’å¾—ã§ãã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
flutter pub add rearch flutter_rearch
```

### ReArchConsumer

Riverpodã® **`ProviderScope`** ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ã§ã™ã­ã€‚`runApp`ã®ç›´å¾Œã«ã“ã‚Œã‚’è¨­ç½®ã—ã¦ã‚„ã‚‹ã“ã¨ã§ReArchãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```dart:main.dart
import 'package:flutter/material.dart';
import 'package:flutter_rearch/flutter_rearch.dart';
import 'package:rearch/rearch.dart';

void main() {
  runApp(RearchBootstrapper(child: Myapp()));
}
```

### RearchConsumer
Riverpodã®`ConsumerWidget`ã‚„[hooks_riverpod](https://pub.dev/packages/hooks_riverpod)ã®`HookConsumerWidget`ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

```dart
class MainPage extends RearchConsumer {
  @override
  Widget build(BuildContext context, WidgetHandle use) {
```

`StatefulRearchConsumer`ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`RearchBuilder`ã¨ã„ã†`RearchConsumer`ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã ã‘ã®WidgetãŒã‚ã‚‹ã®ã§ã€`StatefulWidget`å†…ã§ã¯ãã‚Œã‚’ä½¿ã„ã¾ã™ã€‚

```dart
class MainPage extends StatefulWidget {
  @override
  State<MainPage> createState() => _MainPageState();
}

class _MainPageState extends State<MainPage> {
  @override
  Widget build(BuildContext context) {
    return RearchBuilder(builder:(context, use) {
```

## use.state

React Hooks ã‚„ Flutter Hooks ã® **`useState`** ã«ç›¸å½“ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

Flutter Hooks ã¨é•ã„ã€æœ¬å®¶ã® React Hooks ã®ã‚ˆã†ã« **`(å€¤, å€¤ã‚’æ›´æ–°ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰)`** ãŒã‚»ãƒƒãƒˆã§è¿”ã•ã‚Œã¾ã™ã€‚

```dart
class CounterAndButton extends RearchConsumer {
  @override
  Widget build(BuildContext context, WidgetHandle use) {
    final (count, setCount) = use.state(0);
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Text('$count'),
        // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã‚‹ãŸã³ã«æ•°å­—ãŒ+1ã•ã‚Œã¦ã„ã
        ElevatedButton(
          onPressed: () {
            setCount(count + 1);
          },
          child: const Text('+1'),
        ),
      ],
    );
  }
}
```

## use.memo

React Hook ã® **`useMemo`** ã«ç›¸å½“ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

Flutter Hooks ã«ãŠã‘ã‚‹ **`useMemoized`** ã«ç›¸å½“ã™ã‚‹ã»ã‹ã€ **useScrollControllerã‚„useAnimationController ãªã©ã®ä»£ã‚ã‚Š**ã«ã‚‚ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€**dependencies**ã¨ã„ã†å¼•æ•°ãŒä»˜ã„ã¦ã„ã¦ã€ã“ã“ã«ç›£è¦–ã™ã‚‹å¤‰æ•°ã‚’æ¸¡ã—ã¦ã‚„ã‚‹ã¨ã€ãã®å€¤ãŒå¤‰ã‚ã£ãŸéš›ã«å†ç”Ÿæˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ç‰¹å®šã®å¤‰æ•°ãŒå¤‰åŒ–ã—ãŸå ´åˆã€`use.memo`å´ã§å†è¨ˆç®—ãƒ»å†å–å¾—ã•ã›ãŸã‚Šå‡ºæ¥ã¾ã™ã€‚

```dart
class CounterAndButton extends RearchConsumer {
  @override
  Widget build(BuildContext context, WidgetHandle use) {
    final (count, setCount) = use.state(0);
    // countãŒå¤‰åŒ–ã™ã‚‹ãŸã³ã«TextEditingControllerãŒä½œã‚Šç›´ã•ã‚Œã‚‹
    final textController = use.memo(
      () => TextEditingController(text: '$count'),
      [count],
    );
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        TextField(controller: textController),
        // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã‚‹ãŸã³ã«æ•°å­—ãŒ+1ã•ã‚Œã¦ã„ã
        ElevatedButton(
          onPressed: () {
            setCount(count + 1);
          },
          child: const Text('+1'),
        ),
      ],
    );
  }
}
```

## use.effect

React Hooks ã‚„ Flutter Hooks ã® **`useEffect`** ã«ç›¸å½“ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚`use.memo`ã¯ä½•ã‚‰ã‹ã®å€¤ã‚’è¿”ã—ã¾ã™ãŒã€`use.effect`ã¯è¿”ã—ã¾ã›ã‚“ã€‚

`use.memo`ã¨åŒæ§˜ã«ã€`dependencies`ã«ç›£è¦–ã™ã‚‹å¤‰æ•°ã‚’æ¸¡ã—ã¦ã‚„ã‚‹ã¨ã€ãã®å€¤ãŒå¤‰åŒ–ã—ãŸéš›ã«å†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ã¾ãŸã€`return`ã§ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿”ã›ã‚‹ã®ã§ã™ãŒã€ã“ã‚Œã¯**ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ— (Clean Up)** ã¨è¨€ã£ã¦ã€`dependencies`ãŒå¤‰åŒ–ã—ãŸéš›ã‚„ã€WidgetãŒä½¿ã‚ã‚Œãªããªã‚Šç ´æ£„ã•ã‚Œã‚‹éš›ã«è¡Œã„ãŸã„å‡¦ç†ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```dart
class CountUpTimer extends RearchConsumer {
  @override
  Widget build(BuildContext context, WidgetHandle use) {
    final (seconds, setSeconds) = use.state(0);
    final (isRunning, setIsRunning) = use.state(false);

    use.effect(() {
      Timer? timer;

      if (isRunning) {
        timer = Timer.periodic(Duration(seconds: 1), (timer) {
          setSeconds(seconds + timer.tick);
        });
      }

      // ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—
      return () {
        // ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—ã§å–å¾—ã§ãã‚‹å€¤ã¯ä»¥å‰ã®å€¤
        // isRunningãŒtrueâ†’falseã«ãªã£ãŸã®ã§ã€ä»¥å‰ã®å€¤ãŒtrueã®å ´åˆã«ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
        if (isRunning) {
          print('ã‚¿ã‚¤ãƒãƒ¼ã‚¹ãƒˆãƒƒãƒ—');
          timer?.cancel();
        }
      };
    }, [isRunning]);

    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Text('ç§’æ•°: $seconds'),
        ElevatedButton(
          onPressed: () => setIsRunning(!isRunning),
          child: Text(isRunning ? 'åœæ­¢' : 'é–‹å§‹'),
        ),
      ],
    );
  }
}
```

`dependencies`ã«ä½•ã‚‚æŒ‡å®šã—ãªã„ã€ã¤ã¾ã‚ŠæœªæŒ‡å®šã®å ´åˆã€æœ€åˆã«å®Ÿè¡Œã•ã‚ŒãŸå¾Œã¯äºŒåº¦ã¨å‘¼ã°ã‚Œã‚‹ã“ã¨ãŒãªã„ãŸã‚ã€`StatefulWidget`ã®`initState`ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚ˆã†ãªä½¿ã„æ–¹ãŒå‡ºæ¥ã¾ã™ã€‚

`dependencies`ãŒæœªæŒ‡å®šã®å ´åˆã®ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—ã¯WidgetãŒä½¿ã‚ã‚Œãªããªã‚Šç ´æ£„ã•ã‚Œã‚‹æ™‚ã€ã¤ã¾ã‚Š`StatefulWidget`ã®`dispose`ãƒ¡ã‚½ãƒƒãƒ‰ã«ç›¸å½“ã—ã¾ã™ã€‚

```dart
class MountExampleWidget extends RearchConsumer {
  @override
  Widget build(BuildContext context, WidgetHandle use) {    
    use.effect(() {
      // StatefulWidgetã®initStateã«ç›¸å½“
      print('ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã—ãŸ');
      // StatefulWidgetã®disposeã«ç›¸å½“
      return () {
      	print('ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã™');
      }
    });
```

# useã¨Capsule

ReArchã®è‚ã¨ãªã‚‹æ©Ÿèƒ½ã§ã™ã€‚

å…ˆã»ã©ã®`use.state`ã‚„`use.memo`ã€`use.effect`ã‚’buildãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ä½¿ã†ã ã‘ã§ã‚‚ Flutter Hooks ã¨åŒã˜ã“ã¨ãŒå‡ºæ¥ã¾ã™ãŒã€ReArchã¯**Capsuleã‚’ä½¿ã†ã“ã¨ã§Widgetã®å¤–ã«æŒã¡å‡ºã™ã“ã¨ãŒå‡ºæ¥ã¾ã™**ã€‚

Capsuleã¨ã¯ã€Œ**CapsuleHandleã¨ã„ã†å¼•æ•°ã‚’ä¸€ã¤ã ã‘æŒã£ãŸãƒ¡ã‚½ãƒƒãƒ‰**ã€ã§ã™ã€‚

æœ€å¤§ã®ç‰¹é•·ã¯buildãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ä½¿ãˆã¦ã„ãŸ**use.stateã‚„use.memoã€use.effectãŒãã®ã¾ã¾ä½¿ãˆã‚‹**ã¨ã„ã†ç‚¹ã§ã™ã€‚

ãªã®ã§ã€buildãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ä½¿ç”¨ã—ã¦ã„ãŸ`use.state`ã‚‚ã€Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã£ã¦ãã“ã«ç§»ã™ã ã‘ã§å¤–ã«å‡ºã›ã€ä»–ã®Widgetã‚„ãƒ¢ãƒ‡ãƒ«ã¨å…±æœ‰ã§ãã¾ã™ã€‚

```dart:å…ˆã»ã©ã®CounterAndButtonã®countã‚’Widgetã®å¤–ã«å‡ºã™
(int count, void Function(int) setCount) countCapsule(CapsuleHandle use) {
  final (count, setCount) = use.state(0);
  return (count, setCount);
}

class CounterAndButton extends RearchConsumer {
  @override
  Widget build(BuildContext context, WidgetHandle use) {
    // ä»–ã®Widgetã‚„Capsuleã§ã‚‚use(countCapsule)ã‚’å‘¼ã¹ã°countã®å€¤ã‚’å…±æœ‰ã§ãã‚‹
    final (count, setCount) = use(countCapsule);
```

ã“ã‚ŒãŒReArchãŒAIé§†å‹•é–‹ç™ºã¨ç›¸æ€§ãŒè‰¯ã„æœ€å¤§ã®ç†ç”±ã§ã€AIãŒã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãéš›ã«è©°ã¾ã‚Šã«ãããªã‚Šã¾ã™ã€‚

## æˆ»ã‚Šå€¤ã¯ä½•ã§ã‚‚OK

`use.state`ãŒå¿…ãš **`(å€¤, å€¤ã‚’æ›´æ–°ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰)`** ã®ã‚»ãƒƒãƒˆã«ãªã‚‹ã®ã§Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã‚‚åŒã˜ã ã¨å‹˜é•ã„ã•ã‚ŒãŒã¡ã§ã™ãŒã€å®Ÿã¯ç‰¹ã«åˆ¶é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

```dart:setCountã®ä»£ã‚ã‚Šã«incrementã¨resetã‚’è¿½åŠ ã™ã‚‹
(int count, ({void Function() increment, void Function() reset})) countCapsule(
  CapsuleHandle use,
) {
  final (count, setCount) = use.state(0);
  return (
    count,
    (increment: () => setCount(count + 1), reset: () => setCount(0)),
  );
}

class CounterAndButton extends RearchConsumer {
  @override
  Widget build(BuildContext context, WidgetHandle use) {
    final (count, action) = use(countCapsule);

    action.increment();
    action.reset();
```

å€¤ã ã‘ã‚’è¿”ã›ã°Riverpodã®`Provider`ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```dart
(int count, Function(int) setCount) countCapsule(CapsuleHandle use) {
  final (count, setCount) = use.state(0);
  return (count, setCount);
}

int doubleCountCapsule(CapsuleHandle use) {
  final (count, _) = use(countCapsule);
  return count * 2;
}

class CounterAndButton extends RearchConsumer {
  @override
  Widget build(BuildContext context, WidgetHandle use) {
    final (count, setCount) = use(countCapsule);
    // å¸¸ã«countã®2å€ã®å€¤ã«ãªã‚‹
    final doubleCount = use(doubleCountCapsule);
```

é€†ã«ãƒ¡ã‚½ãƒƒãƒ‰ã ã‘ã‚’è¿”ã™ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚

```dart
(int count, Function(int) setCount) countCapsule(CapsuleHandle use) {
  final (count, setCount) = use.state(0);
  return (count, setCount);
}

// countã®resetã ã‘ãŒå‡ºæ¥ã‚‹Capsule
void Function() resetCountCapsule(CapsuleHandle use) {
  final (_, setCount) = use(countCapsule);
  return () {
    setCount(0);
  };
}

class CounterAndButton extends RearchConsumer {
  @override
  Widget build(BuildContext context, WidgetHandle use) {
    final countReset = use(resetCountCapsule);
    
    countReset();
```

ã•ã‚‰ã«ã€åˆ¶é™ãŒç„¡ã„ã¨è¨€ã†ã“ã¨ã¯ **`(å€¤, å€¤ã‚’æ›´æ–°ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰)`** ã®ä»£ã‚ã‚Šã«ã€Œ**ä¸¡æ–¹ã‚’æŒã£ãŸã‚¯ãƒ©ã‚¹**ã€ã«ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

```dart
class Counter {
  final int count;
  final void Function(int) _setState;
  const Counter(this.count, this._setState);

  void increment() {
    _setState(count + 1);
  }
}

Counter counterCapsule(CapsuleHandle use) {
  final (counter, setState) = use.state(0);
  return Counter(counter, setState);
}

class CounterAndButton extends RearchConsumer {
  @override
  Widget build(BuildContext context, WidgetHandle use) {
    final counter = use(counterCapsule);

    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Text('${counter.count}'),
        ElevatedButton(
          onPressed: () {
            counter.increment();
          },
          child: Text('+1'),
        ),
      ],
    );
  }
}
```

ã“ã‚Œã‚’ä¾‹ãˆã°ã€Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã§è¿”ã™ã‚¯ãƒ©ã‚¹ã‚’ `abstract interface` ã«ã™ã‚Œã°ã€ãã‚Œã‚’`implements`ã—ãŸã‚¯ãƒ©ã‚¹ãªã‚‰ä½•ã§ã‚‚è¿”ã›ã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã¤ã¾ã‚Šãƒ†ã‚¹ãƒˆæ™‚ã«ã¯ãƒ¢ãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚’è¿”ã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã‹ã‚‰ã€Riverpodã®`dependencyOverrides`ã¨åŒã˜ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

# Capsuleâ‰’Provider

ä¸Šè¨˜ã®é€šã‚Šã€Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã¯Riverpodã«ãŠã‘ã‚‹`Provider`ã«ç›¸å½“ã—ã€useã¯`ref.watch`ã«ç›¸å½“ã—ã¾ã™ã€‚

ã¡ãªã¿ã«ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è§£æ”¾ã•ã›ã‚‹ã“ã¨ã¯å‡ºæ¥ãšã€å…¨ã¦AutoDisposeã¨åŒã˜æ‰±ã„ã§ã™ã€‚

ã¤ã¾ã‚Šã©ã“ã‹ã‚‰ã‚‚`use`ã§ä½¿ã‚ã‚Œãªããªã£ãŸã‚‰è‡ªå‹•ã§è§£æ”¾ã•ã‚Œã€æ¬¡ã«`use`ã‚’ä½¿ã†ã¨åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚
è‡ªå‹•è§£æ”¾ã¨ã„ã†ã“ã¨ã¯AIãŒè‹¦æ‰‹ãªã®ã§ã¯ï¼Ÿã¨æ€ã‚ã‚Œãã†ã§ã™ãŒã€`watch`ã—ãªãã¦ã‚‚æ›´æ–°ã§ãã¦ã—ã¾ã†Riverpodã¨ã¯é•ã„ã€å¿…ãš`use`(â‰’`watch`)ã‚’ä½¿ã†ä»•æ§˜ãªã®ã§å•é¡ŒãŒèµ·ãã«ãã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

# ã©ã†ã„ã†ä»•çµ„ã¿ã§çŠ¶æ…‹ç®¡ç†ã—ã¦ã„ã‚‹ã®ã‹

æœ€åˆã¯ã€Œ**ä½•ã§ãƒ¡ã‚½ãƒƒãƒ‰ã§çŠ¶æ…‹ç®¡ç†ã§ãã‚‹ã®ï¼Ÿé­”æ³•ã‹ï¼Ÿï¼Ÿ**ã€ã¨æ€ã„ã¾ã—ãŸãŒã€æµçŸ³ã«è‰²ã€…è©¦ã—ã¦ã¿ã‚‹ã¨å®Ÿè£…ãŒä½•ã¨ãªãç†è§£ã§ãã¾ã—ãŸã€‚
ä»•çµ„ã¿ã¨ã—ã¦ã¯**ãƒ¡ã‚½ãƒƒãƒ‰ã®hashCode**ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

æ™®æ®µãƒ¡ã‚½ãƒƒãƒ‰ã¯()ã‚’ä½¿ã£ã¦å‘¼ã³å‡ºã™ã ã‘ã®æ–¹ãŒã»ã¨ã‚“ã©ã ã¨æ€ã„ã¾ã™ãŒã€å®Ÿéš›ã¯`Function`ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

ã¤ã¾ã‚Šã€ä»–ã®å‹ã‚„ã‚¯ãƒ©ã‚¹ã¨åŒã˜ã‚ˆã†ã«ã€**hashCode**ã¨ã„ã†é‡è¤‡ã—ãªã„å€¤ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

ReArchã¯ã“ã®**hashCodeã‚’Mapã®ã‚­ãƒ¼ã«ã™ã‚‹**ã“ã¨ã§çŠ¶æ…‹ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

æµã‚Œã¨ã—ã¦ã¯

1. **useã®å¼•æ•°ã«Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¸¡ã™**
2. **å¿…è¦ã«ãªã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§Capsuleãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹**
3. **ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§å‘¼ã³å‡ºã•ã‚ŒãŸuse.stateã‚„use.memoã‚’ã€ãã®Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã®hashCodeã‚’Mapã®ã‚­ãƒ¼ã«ã—ã¦çŠ¶æ…‹ç®¡ç†**

ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚

ï¼ˆä¸Šè¨˜ã¯æ™‚ã€…ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿ã¤ã¤ã—ã°ã‚‰ãä½¿ã£ã¦ã®æ¨æ¸¬ + DeepResearchã«ã‚ˆã‚‹èª¿æŸ»ã«ã‚ˆã‚‹ã‚‚ã®ãªã®ã§ã€é–“é•ã£ã¦ã„ãŸã‚‰ã”æŒ‡æ‘˜ãã ã•ã„ï¼‰

ã“ã®ã€Œ**Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã®hashCodeã‚’ã‚­ãƒ¼ã«ã—ã¦ã„ã‚‹**ã€ã¨ã„ã†ä»•æ§˜ã¯é‡è¦ãªç‚¹ã§ã€ReArchã§å®Ÿè£…ã™ã‚‹éš›ã«è€ƒæ…®ã™ã‚‹å¿…è¦ãŒåº¦ã€…ã‚ã‚Šã¾ã™ã€‚

# ReArchã®é›£ã—ã„ç‚¹

ã“ã“ã¾ã§æ›¸ãã¨ã€Œ**ReArchã£ã¦ Riverpod x Flutter Hooks ã®å®Œå…¨ä¸Šä½äº’æ›ãªã®ã§ã¯**ã€ã¨æ€ã‚ã‚Œã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚ã—ã‹ã—å®Ÿéš›ã«ã¯ã€å®Ÿè£…é›£æ˜“åº¦ãŒé«˜ã„ã®ã§å¿…ãšã—ã‚‚ãã†ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚

## è‡ªç”±åº¦ãŒé«˜ã„

ReArchã®æœ€å¤§ã®ç‰¹é•·ã¯**è‡ªç”±åº¦ã®é«˜ã•**ã§ã™ã€‚RiverpodãŒæ§˜ã€…ãªæ©Ÿèƒ½ã‚’ã‚ã‚‰ã‹ã˜ã‚æä¾›ã—ã¦ã„ã‚‹ã®ã«å¯¾ã—ã€ReArchã¯ã‚ãˆã¦æœ€å°é™ã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã“ã¨ã§ã€é–‹ç™ºè€…ã«å®Ÿè£…ã®è‡ªç”±ã‚’å§”ã­ã¦ã„ã¾ã™ã€‚

ReArchã¯è‰²ã€…ãªãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é§†ä½¿ã™ã‚Œã°ã€æã‚‰ãRiverpodã¨å…¨ãåŒã˜ã“ã¨ãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã—ã€Riverpodã§æ‚©ã¿ã®ç¨®ã ã£ãŸç‚¹ã‚‚è§£æ¶ˆã§ãã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚

ãŸã ãã®åˆ†ã€å®Ÿè£…ã‚„è¨­è¨ˆã®ã‚»ãƒ³ã‚¹ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ãƒãƒ¼ãƒ ã§é–‹ç™ºã™ã‚‹å ´åˆã¯çµæ§‹ãªæ™‚é–“ã‚’è­°è«–ã«å‰²ãã“ã¨ã«ãªã‚Šãã†ã§ã™ã€‚

Riverpodã®ã‚ˆã†ã«æ©Ÿèƒ½ãŒè±Šå¯Œãªã“ã¨ã¯ã€**è­°è«–ã®ä½™åœ°ãŒå°‘ãªããªã‚‹**ã¨ã„ã†åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

ä¸€æ–¹ã§ReArchã®è‡ªç”±åº¦ã®é«˜ã•ã¯ã€**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¨ã£ã¦æœ€é©ãªè¨­è¨ˆã«å‡ºæ¥ã‚‹**å¯èƒ½æ€§ã‚’ç§˜ã‚ã¦ã„ã¾ã™ã€‚

ã©ã¡ã‚‰ã‚’é¸ã¶ã¹ãã‹ã¯ãƒãƒ¼ãƒ ã‚„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚ˆã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„çŸ¥è¦‹ãŒå°‘ãªã„

ReArchãŒpub.devã«ç™»å ´ã—ãŸã®ã¯2024å¹´ã®10æœˆã§ã™ã€‚ã¾ã ä¸€å¹´ã‚‚çµŒã£ã¦ã„ã¾ã›ã‚“ã€‚

ã¾ãŸã€Riverpodã¯æ¥­ç•Œæ¨™æº–ã¨ãªã‚‹çŠ¶æ…‹ç®¡ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæ±ºã¾ã£ã¦ã„ãªã‹ã£ãŸé ƒã«ç™»å ´ã—ãŸãŸã‚ã€å½“æ™‚ã¯Flutterã«ãŠã‘ã‚‹æ•‘ä¸–ä¸»ã®ã‚ˆã†ãªå­˜åœ¨ã§ã—ãŸã€‚ãªã®ã§éå¸¸ã«æ´»ç™ºã«è­°è«–ã‚„çŸ¥è¦‹ã®å…±æœ‰ãŒè¡Œã‚ã‚Œã¦ã„ãŸè¨˜æ†¶ãŒã‚ã‚Šã¾ã™ã€‚

ä»Šã¯ã‚‚ã†Flutterã¯æˆç†ŸæœŸã«è¿‘ã„ã®ã§ã€ReArchãŒæ™®åŠã™ã‚‹ã¾ã§ã«æ™‚é–“ã¯ã‹ã‹ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

## Familyã«ç›¸å½“ã™ã‚‹æ›¸ãæ–¹

Riverpodã«ã¯**Family**ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã¯ã€åŸºæœ¬çš„ã«ä¸€ã¤ã®å€¤ã‚’çŠ¶æ…‹ç®¡ç†ã™ã‚‹ã ã‘ã®Providerã«å¯¾ã—ã€è¿½åŠ ã§å¼•æ•°ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

åŒã˜Providerã§ã‚ã£ã¦ã‚‚ã€å¼•æ•°ãŒç•°ãªã‚‹ã¨åˆ¥ã®Providerã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’çŠ¶æ…‹ç®¡ç†ã™ã‚‹`accountProvider`ã¨ã„ã†`NotifierProvider`ãŒã‚ã£ãŸå ´åˆã€Familyã§userIdã‚’æ¸¡ã™ã‚ˆã†ã«ã™ã‚Œã°ã€userIdã”ã¨ã«ç•°ãªã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ãŒç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã•ã‚‰ã«ã€ Riverpod Generator ã‚’ä½¿ãˆã°äºŒã¤ä»¥ä¸Šã®å¼•æ•°ã‚’å—ã‘å–ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

ReArchã¯[pub.devã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸](https://pub.dev/packages/rearch)(Why not Riverpod? ã®æ‰€)ãªã©ã§æ˜ç¢ºã«Familyã‚’æ‰¹åˆ¤ã—ã¦ã„ã¦ã€ä»£ã‚ã‚Šã«**Factoryãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã†ã¹ãã **ã¨æ›¸ã„ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã«ã€ReArchã¯Factoryãƒ‘ã‚¿ãƒ¼ãƒ³ãªã©ã‚’ç”¨ã„ã‚‹ã“ã¨ã§Familyã¨åŒã˜ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

ãŒã€ã—ã‹ã—ã€ã“ã‚ŒãŒä¸­ã€…é›£ã—ã„â€¦ã€‚

ã€Œ**Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã«è¿½åŠ ã§å¼•æ•°ã‚’æŒãŸã›ã‚Œã°è‰¯ã„ã®ã§ã¯**ã€ã¨æœ€åˆã¯æ€ã„ã¾ã—ãŸãŒã€Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã¯`CapsuleHandle`ä¸€ã¤ã—ã‹å¼•æ•°ã‚’æŒã¦ã¾ã›ã‚“ã€‚
ä»®ã«æŒãŸã›ã‚‰ã‚ŒãŸã¨ã—ã¦ã‚‚ã€å¼•æ•°ã«ä½•ã‚’æ¸¡ã—ã¦ã‚‚ãƒ¡ã‚½ãƒƒãƒ‰ã®`hashCode`ã¯å¤‰ã‚ã‚‰ãªã„ã®ã§ã€å¼•æ•°ã«å¿œã˜ã¦çŠ¶æ…‹ç®¡ç†ã‚’åˆ†ã‘ã‚‹ã“ã¨ã¯å‡ºæ¥ã¾ã›ã‚“ã€‚

è§£æ±ºç­–ã¯ã€**Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã‚’é–¢æ•°å†…é–¢æ•°ã«ã™ã‚‹**ã“ã¨ã§ã™ã€‚

ãŸã ã—ã€é–¢æ•°å†…é–¢æ•°ã¯è¦ªã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚ŒãŸéš›ã«æ–°ã—ãä½œã‚‰ã‚Œã‚‹ã®ã§ã€`hashCode`ãŒæ¯å›å¤‰ã‚ã£ã¦ã—ã¾ã„ã¾ã™ã€‚ãã®ãŸã‚ã€å¼•æ•°ã‚’ã‚­ãƒ¼ã«ã™ã‚‹ãªã©ã®æ–¹æ³•ã§Mapã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```dart
// å‹åãŒé•·ã„ã®ã§typedefã—ã¦ãŠã
typedef AccountCapsuleReturn = (Account, void Function(Account));
typedef AccountCapsuleCallback = AccountCapsuleReturn Function(CapsuleHandle);

// ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã”ã¨ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
final _accountCapsuleCache = <String, AccountCapsuleCallback>{};

class Account {
  final String userName;
  const Account({required this.userName});
}

AccountCapsuleCallback accountCapsuleFactory({required String userId}) {
  AccountCapsuleReturn accountCapsule(CapsuleHandle use) {
    final (account, updateAccount) = use.state(
      Account(userName: 'none'),
    );
    return (account, updateAccount);
  }

  // _accountCapsuleCacheã«æ—¢ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¿”ã—ã€
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ãªã„å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã‹ã‚‰è¿”ã™
  return (_accountCapsuleCache[userId] ??= accountCapsule);
}

class MyPage extends RearchConsumer {
  @override
  Widget build(BuildContext context, WidgetHandle use) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒç•°ãªã‚‹ã¨åˆ¥ã€…ã®Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹
    final (user1, updateUser1) = use(accountCapsuleFactory(userId: "user001"));
    final (user2, updateUser2) = use(accountCapsuleFactory(userId: "user002"));
```

ã¡ãªã¿ã«ã€ã“ã®Capsuleãƒ¡ã‚½ãƒƒãƒ‰ãŒã©ã“ã‹ã‚‰ã‚‚ä½¿ã‚ã‚Œãªããªã‚Šã€è§£æ”¾ã•ã‚Œã¦ã‚‚`_accountCapsuleCache`ã«ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ®‹ã£ã¦ã„ã¾ã™ãŒã€ç‰¹ã«å‹•ä½œã«å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚çŠ¶æ…‹ç®¡ç†ã—ã¦ã„ã‚‹ã®ã¯ReArchå´ãªã®ã§ã€æ¬¡å›å‘¼ã‚“ã éš›ã«ã¯åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã¨ã¯ã„ãˆã“ã®å®Ÿè£…ã ã¨æ®‹ã£ãŸãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦ãƒ¡ãƒ¢ãƒªãƒ¼æ¶ˆè²»ãŒå¢—ãˆã‚‹ã®ã§ã€æœ¬æ ¼çš„ã«ç®¡ç†ã—ãŸã„å ´åˆã¯å°‚ç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚Šã€Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã‚‚ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰è¿”ã™ãªã©ã®è¨­è¨ˆã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

# `setState() or markNeedsBuild() called during build.` ã¨å‡ºãŸå ´åˆ

Flutter Hooks ã§ã‚‚æ™‚ã€…èµ·ãã‚‹ç¾è±¡ã§ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
```
The following assertion was thrown building CounterAndButton(dirty, dependencies:
[CapsuleContainerProvider]):
setState() or markNeedsBuild() called during build.
This CounterAndButton widget cannot be marked as needing to build because the framework is already
in the process of building widgets. A widget can be marked as needing to be built during the build
phase only if one of its ancestors is currently building. This exception is allowed because the
framework builds parent widgets before children, which means a dirty descendant will always be
built. Otherwise, the framework might not visit this widget during this build phase.
The widget on which setState() or markNeedsBuild() was called was:
  CounterAndButton
The widget which was currently being built when the offending call was made was:
  CounterAndButton
```

WidgetãŒæç”»ã•ã‚Œã‚‹å‰ã«`use.effect`ã§Capsuleãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ›´æ–°ã—ãŸéš›ã«èµ·ã“ã‚‹ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚
ä¿®æ­£ã‚‚ Flutter Hooks ã¨åŒã˜ã§ã€`WidgetsFlutterBinding.ensureInitialized().addPostFrameCallback`ã‚’`use.effect`ã®ä¸­ã§ä½¿ã„ã¾ã™ã€‚
```dart
use.effect( () {
  WidgetsFlutterBinding.ensureInitialized().addPostFrameCallback((_) {
    // ã“ã®ä¸­ã«å‡¦ç†ã‚’æ›¸ã
  });
});
```

# Discordã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã‚’ä½œã‚Šã¾ã—ãŸï¼ˆå®£ä¼ï¼‰
ç´°ã€…ã¨é‹å–¶ã—ã¦ã„ã‚‹Flutterã‚¢ãƒ—ãƒªé–‹ç™ºè€…å°‚ç”¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¼ã§ã™ã€‚
ã¡ã‚‡ã„ã¡ã‚‡ã„çŸ¥è¦‹å…±æœ‰ãªã©ã‚’è¡Œãªã£ã¦ã„ã‚‹ã®ã§ãŠæ°—è»½ã«ã”å‚åŠ ãã ã•ã„ğŸ˜Š
https://discord.gg/C4bxjk56UQ

# å‚™è€ƒ

æœ¬è¨˜äº‹ã¯ä»¥ä¸‹ã®ç’°å¢ƒã§æ¤œè¨¼ã—ã¾ã—ãŸ
```
rearch: 1.16.1
flutter_rearch: 1.7.2
```
```
Flutter 3.35.2 â€¢ channel stable â€¢ https://github.com/flutter/flutter.git
Framework â€¢ revision 05db968908 (7 days ago) â€¢ 2025-08-25 10:21:35 -0700
Engine â€¢ hash abb725c9a5211af2a862b83f74b7eaf2652db083 (revision a8bfdfc394) (9
days ago) â€¢ 2025-08-22 23:51:12.000Z
Tools â€¢ Dart 3.9.0 â€¢ DevTools 2.48.0
```